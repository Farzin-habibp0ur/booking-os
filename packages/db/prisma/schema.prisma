generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Business {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  phone        String?
  timezone     String   @default("UTC")
  verticalPack  String   @default("general")
  packConfig    Json     @default("{}")
  defaultLocale String   @default("en")
  aiSettings    Json     @default("{}")
  notificationSettings Json @default("{}")
  policySettings    Json     @default("{}")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  staff             Staff[]
  customers         Customer[]
  services          Service[]
  bookings          Booking[]
  recurringSeries   RecurringSeries[]
  conversations     Conversation[]
  reminders         Reminder[]
  messageTemplates  MessageTemplate[]
  translations      Translation[]
  subscription      Subscription?
  aiUsage           AiUsage[]
  roiBaselines      RoiBaseline[]
  waitlistEntries   WaitlistEntry[]
  automationRules   AutomationRule[]
  campaigns         Campaign[]
  offers            Offer[]
  locations         Location[]
  quotes            Quote[]
  verticalPackVersions VerticalPackVersion[]

  @@map("businesses")
}

model Staff {
  id            String   @id @default(cuid())
  businessId    String
  name          String
  email         String   @unique
  passwordHash  String?
  role          String   @default("AGENT") // ADMIN, SERVICE_PROVIDER, AGENT
  locale        String?
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  business              Business              @relation(fields: [businessId], references: [id])
  bookings              Booking[]
  recurringSeries       RecurringSeries[]
  conversations         Conversation[]        @relation("AssignedConversations")
  messages              Message[]             @relation("SentMessages")
  notes                 ConversationNote[]    @relation("StaffNotes")
  workingHours          WorkingHours[]
  timeOff               TimeOff[]
  calendarConnections   CalendarConnection[]
  waitlistEntries       WaitlistEntry[]       @relation("PreferredStaffWaitlist")
  staffLocations        StaffLocation[]

  @@index([businessId])
  @@map("staff")
}

model Customer {
  id           String   @id @default(cuid())
  businessId   String
  name         String
  phone        String
  email        String?
  tags         String[] @default([])
  customFields Json     @default("{}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  business        Business          @relation(fields: [businessId], references: [id])
  bookings        Booking[]
  recurringSeries RecurringSeries[]
  conversations   Conversation[]
  waitlistEntries WaitlistEntry[]

  @@unique([businessId, phone])
  @@index([businessId])
  @@map("customers")
}

model Service {
  id             String   @id @default(cuid())
  businessId     String
  name           String
  description    String?
  durationMins   Int
  price          Float    @default(0)
  category       String   @default("General")
  kind           String   @default("OTHER") // CONSULT, TREATMENT, OTHER
  isActive       Boolean  @default(true)
  depositRequired Boolean @default(false)
  depositAmount  Float?
  bufferBefore   Int      @default(0)
  bufferAfter    Int      @default(0)
  customFields   Json     @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  business        Business          @relation(fields: [businessId], references: [id])
  bookings        Booking[]
  recurringSeries RecurringSeries[]
  waitlistEntries WaitlistEntry[]

  @@index([businessId])
  @@map("services")
}

model Booking {
  id             String   @id @default(cuid())
  businessId     String
  customerId     String
  serviceId      String
  staffId        String?
  conversationId String?
  recurringSeriesId String?
  locationId     String?
  resourceId     String?
  kanbanStatus   String?
  status         String   @default("PENDING")
  startTime      DateTime
  endTime        DateTime
  notes                     String?
  externalCalendarEventId   String?
  customFields              Json     @default("{}")
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  business        Business         @relation(fields: [businessId], references: [id])
  customer        Customer         @relation(fields: [customerId], references: [id])
  service         Service          @relation(fields: [serviceId], references: [id])
  staff           Staff?           @relation(fields: [staffId], references: [id])
  conversation    Conversation?    @relation(fields: [conversationId], references: [id])
  recurringSeries RecurringSeries? @relation(fields: [recurringSeriesId], references: [id])
  location        Location?        @relation(fields: [locationId], references: [id])
  resource        Resource?        @relation(fields: [resourceId], references: [id])
  reminders       Reminder[]
  payments        Payment[]
  quotes          Quote[]

  @@index([businessId])
  @@index([businessId, startTime])
  @@index([businessId, status])
  @@index([locationId])
  @@index([resourceId])
  @@map("bookings")
}

model RecurringSeries {
  id            String    @id @default(cuid())
  businessId    String
  customerId    String
  serviceId     String
  staffId       String?
  timeOfDay     String
  daysOfWeek    Int[]
  intervalWeeks Int       @default(1)
  totalCount    Int
  endsAt        DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  business Business  @relation(fields: [businessId], references: [id])
  customer Customer  @relation(fields: [customerId], references: [id])
  service  Service   @relation(fields: [serviceId], references: [id])
  staff    Staff?    @relation(fields: [staffId], references: [id])
  bookings Booking[]

  @@index([businessId])
  @@map("recurring_series")
}

model Conversation {
  id            String    @id @default(cuid())
  businessId    String
  customerId    String
  assignedToId  String?
  locationId    String?
  channel       String    @default("WHATSAPP")
  status        String    @default("OPEN")
  lastMessageAt DateTime?
  snoozedUntil  DateTime?
  tags          String[]  @default([])
  metadata      Json      @default("{}")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  business   Business           @relation(fields: [businessId], references: [id])
  customer   Customer           @relation(fields: [customerId], references: [id])
  assignedTo Staff?             @relation("AssignedConversations", fields: [assignedToId], references: [id])
  location   Location?          @relation(fields: [locationId], references: [id])
  messages   Message[]
  bookings   Booking[]
  notes      ConversationNote[]

  @@index([businessId])
  @@index([businessId, status])
  @@index([locationId])
  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  direction      String
  senderStaffId  String?
  content        String
  contentType    String   @default("TEXT")
  externalId     String?  @unique
  metadata       Json     @default("{}")
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
  senderStaff  Staff?       @relation("SentMessages", fields: [senderStaffId], references: [id])

  @@index([conversationId])
  @@map("messages")
}

model Reminder {
  id          String    @id @default(cuid())
  businessId  String
  bookingId   String
  templateId  String?
  scheduledAt DateTime
  sentAt      DateTime?
  status      String    @default("PENDING")
  type        String    @default("REMINDER")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  business Business         @relation(fields: [businessId], references: [id])
  booking  Booking          @relation(fields: [bookingId], references: [id])
  template MessageTemplate? @relation(fields: [templateId], references: [id])

  @@index([businessId])
  @@index([status, scheduledAt])
  @@map("reminders")
}

model MessageTemplate {
  id         String   @id @default(cuid())
  businessId String
  name       String
  category   String   @default("CUSTOM")
  body       String
  variables  String[] @default([])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business  Business   @relation(fields: [businessId], references: [id])
  reminders Reminder[]

  @@index([businessId])
  @@map("message_templates")
}

model ConversationNote {
  id             String   @id @default(cuid())
  conversationId String
  staffId        String
  content        String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
  staff        Staff        @relation("StaffNotes", fields: [staffId], references: [id])

  @@index([conversationId])
  @@map("conversation_notes")
}

model WorkingHours {
  id        String @id @default(cuid())
  staffId   String
  dayOfWeek Int    // 0=Sunday, 1=Monday, ..., 6=Saturday
  startTime String // "09:00" (HH:mm format)
  endTime   String // "17:00" (HH:mm format)
  isOff     Boolean @default(false)

  staff Staff @relation(fields: [staffId], references: [id])

  @@unique([staffId, dayOfWeek])
  @@map("working_hours")
}

model TimeOff {
  id        String   @id @default(cuid())
  staffId   String
  startDate DateTime
  endDate   DateTime
  reason    String?
  createdAt DateTime @default(now())

  staff Staff @relation(fields: [staffId], references: [id])

  @@index([staffId])
  @@map("time_off")
}

model Translation {
  id         String   @id @default(cuid())
  businessId String
  locale     String
  key        String
  value      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  @@unique([businessId, locale, key])
  @@index([businessId, locale])
  @@map("translations")
}

model Subscription {
  id                    String    @id @default(cuid())
  businessId            String    @unique
  stripeCustomerId      String
  stripeSubscriptionId  String    @unique
  plan                  String    @default("basic") // basic, pro
  status                String    @default("active") // active, past_due, canceled, trialing
  currentPeriodEnd      DateTime
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  @@index([stripeCustomerId])
  @@map("subscriptions")
}

model Payment {
  id                    String    @id @default(cuid())
  bookingId             String
  stripePaymentIntentId String    @unique
  amount                Float
  currency              String    @default("usd")
  status                String    @default("pending") // pending, succeeded, failed, refunded
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([bookingId])
  @@map("payments")
}

model AiUsage {
  id         String   @id @default(cuid())
  businessId String
  date       String   // "2024-01-15" format
  count      Int      @default(0)
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  @@unique([businessId, date])
  @@index([businessId])
  @@map("ai_usage")
}

model Token {
  id         String    @id @default(cuid())
  token      String    @unique
  type       String    // PASSWORD_RESET, STAFF_INVITE, RESCHEDULE_LINK, CANCEL_LINK, EMAIL_VERIFY
  email      String
  businessId String?
  staffId    String?
  bookingId  String?
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  @@index([token])
  @@index([email, type])
  @@index([bookingId, type])
  @@map("tokens")
}

model RoiBaseline {
  id            String   @id @default(cuid())
  businessId    String
  goLiveDate    DateTime
  baselineStart DateTime
  baselineEnd   DateTime
  metrics       Json
  createdAt     DateTime @default(now())

  business Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@map("roi_baselines")
}

model CalendarConnection {
  id              String    @id @default(cuid())
  staffId         String
  provider        String    // "google", "outlook"
  accessToken     String    // encrypted AES-256-GCM
  refreshToken    String    // encrypted AES-256-GCM
  tokenExpiresAt  DateTime?
  calendarId      String?   // e.g. "primary" for Google
  icalFeedToken          String?   @unique  // random token for iCal feed URL
  icalFeedTokenExpiresAt DateTime?
  syncEnabled            Boolean   @default(true)
  lastSyncedAt    DateTime?
  lastSyncError   String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  staff Staff @relation(fields: [staffId], references: [id])

  @@unique([staffId, provider])
  @@index([staffId])
  @@map("calendar_connections")
}

model WaitlistEntry {
  id              String    @id @default(cuid())
  businessId      String
  customerId      String
  serviceId       String
  staffId         String?
  timeWindowStart String?
  timeWindowEnd   String?
  dateFrom        DateTime?
  dateTo          DateTime?
  notes           String?
  status          String    @default("ACTIVE") // ACTIVE, OFFERED, BOOKED, EXPIRED, CANCELLED
  offeredAt       DateTime?
  offerExpiresAt  DateTime?
  offeredSlot     Json?
  claimedAt       DateTime?
  bookingId       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  service  Service  @relation(fields: [serviceId], references: [id])
  staff    Staff?   @relation("PreferredStaffWaitlist", fields: [staffId], references: [id])

  @@index([businessId, status])
  @@index([businessId, serviceId, status])
  @@map("waitlist_entries")
}

model AutomationRule {
  id                   String   @id @default(cuid())
  businessId           String
  name                 String
  trigger              String   // BOOKING_CREATED, BOOKING_UPCOMING, STATUS_CHANGED, NO_RESPONSE, TAG_APPLIED, BOOKING_CANCELLED
  filters              Json     @default("{}")
  actions              Json     @default("[]")
  isActive             Boolean  @default(true)
  playbook             String?
  quietStart           String?
  quietEnd             String?
  maxPerCustomerPerDay Int      @default(3)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  business Business        @relation(fields: [businessId], references: [id])
  logs     AutomationLog[]

  @@index([businessId, isActive])
  @@map("automation_rules")
}

model AutomationLog {
  id               String   @id @default(cuid())
  automationRuleId String
  businessId       String
  bookingId        String?
  customerId       String?
  conversationId   String?
  action           String
  outcome          String   // SENT, SKIPPED, FAILED
  reason           String?
  metadata         Json     @default("{}")
  createdAt        DateTime @default(now())

  rule AutomationRule @relation(fields: [automationRuleId], references: [id])

  @@index([businessId, createdAt])
  @@index([automationRuleId])
  @@map("automation_logs")
}

model Campaign {
  id                String    @id @default(cuid())
  businessId        String
  name              String
  status            String    @default("DRAFT") // DRAFT, SCHEDULED, SENDING, SENT, CANCELLED
  templateId        String?
  filters           Json      @default("{}")
  scheduledAt       DateTime?
  sentAt            DateTime?
  throttlePerMinute Int       @default(10)
  stats             Json      @default("{}")
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  business Business       @relation(fields: [businessId], references: [id])
  sends    CampaignSend[]

  @@index([businessId])
  @@map("campaigns")
}

model CampaignSend {
  id         String    @id @default(cuid())
  campaignId String
  customerId String
  status     String    @default("PENDING") // PENDING, SENT, DELIVERED, READ, FAILED
  sentAt     DateTime?
  bookingId  String?
  createdAt  DateTime  @default(now())

  campaign Campaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId, status])
  @@map("campaign_sends")
}

model Offer {
  id                 String    @id @default(cuid())
  businessId         String
  name               String
  description        String?
  terms              String?
  serviceIds         String[]  @default([])
  validFrom          DateTime?
  validUntil         DateTime?
  isActive           Boolean   @default(true)
  maxRedemptions     Int?
  currentRedemptions Int       @default(0)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  business Business @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@map("offers")
}

model Location {
  id             String    @id @default(cuid())
  businessId     String
  name           String
  address        String?
  isBookable     Boolean   @default(true)
  whatsappConfig Json?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  business       Business         @relation(fields: [businessId], references: [id])
  bookings       Booking[]
  resources      Resource[]
  staffLocations StaffLocation[]
  conversations  Conversation[]

  @@index([businessId])
  @@map("locations")
}

model Resource {
  id         String   @id @default(cuid())
  locationId String
  name       String
  type       String
  isActive   Boolean  @default(true)
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  location Location  @relation(fields: [locationId], references: [id])
  bookings Booking[]

  @@index([locationId])
  @@index([type])
  @@map("resources")
}

model StaffLocation {
  id         String @id @default(cuid())
  staffId    String
  locationId String

  staff    Staff    @relation(fields: [staffId], references: [id])
  location Location @relation(fields: [locationId], references: [id])

  @@unique([staffId, locationId])
  @@map("staff_locations")
}

model VerticalPackVersion {
  id          String   @id @default(cuid())
  businessId  String?
  slug        String
  version     Int      @default(1)
  name        String
  description String?
  config      Json
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business? @relation(fields: [businessId], references: [id])

  @@unique([slug, version])
  @@index([slug])
  @@map("vertical_pack_versions")
}

model Quote {
  id          String    @id @default(cuid())
  bookingId   String
  businessId  String
  description String
  totalAmount Float
  pdfUrl      String?
  status      String    @default("PENDING")
  approvedAt  DateTime?
  approverIp  String?
  tokenId     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [id])
  business Business @relation(fields: [businessId], references: [id])

  @@index([bookingId])
  @@index([businessId])
  @@map("quotes")
}
